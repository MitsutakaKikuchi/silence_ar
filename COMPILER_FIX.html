<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>MindAR Target Compiler (Automated)</title>
  <style>
    body { font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; padding: 40px; text-align: center; background: #f0f2f5; }
    .container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
    #status { margin: 20px; padding: 15px; border-radius: 8px; background: #e9ecef; min-height: 50px; font-weight: bold; color: #333; white-space: pre-wrap; }
    #progress-container { width: 100%; background-color: #ddd; border-radius: 8px; margin: 20px 0; display: none; }
    #progress-bar { width: 0%; height: 20px; background-color: #4CAF50; border-radius: 8px; transition: width 0.3s; }
    button { padding: 12px 30px; font-size: 1.1rem; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 6px; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    #download-link { 
        display: none; margin-top: 20px; padding: 15px; background: #28a745; color: white; 
        text-decoration: none; border-radius: 6px; font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>MindAR Target Compiler</h1>
    <p>10点のエピソード画像を 1つの targets.mind ファイルにまとめます。</p>
    
    <button id="start-btn">コンパイル開始</button>
    
    <div id="progress-container">
        <div id="progress-bar"></div>
    </div>
    <div id="status">待機中... (コンパイル開始をクリックしてください)</div>
    <a id="download-link" href="#">targets.mind をダウンロード</a>
  </div>

  <script type="module">
    import { Compiler } from "https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image.prod.js";

    const IMAGE_COUNT = 10;
    const startBtn = document.getElementById("start-btn");
    const status = document.getElementById("status");
    const progressBar = document.getElementById("progress-bar");
    const progressContainer = document.getElementById("progress-container");
    const downloadLink = document.getElementById("download-link");

    async function loadImage(url) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.crossOrigin = "anonymous";
            img.onload = () => resolve(img);
            img.onerror = () => reject(new Error("画像の読み込みに失敗しました: " + url));
            img.src = url;
        });
    }

    startBtn.addEventListener("click", async () => {
      startBtn.disabled = true;
      status.innerText = "コンパイル準備中...";
      status.style.color = "#333";
      
      try {
        progressContainer.style.display = "block";
        const images = [];
        
        for (let i = 1; i <= IMAGE_COUNT; i++) {
          const url = "compiler_images/episode_" + i + ".jpg";
          status.innerText = "画像を読み込み中 (" + i + "/" + IMAGE_COUNT + "): " + url;
          progressBar.style.width = (i / IMAGE_COUNT * 20) + "%";
          images.push(await loadImage(url));
        }

        status.innerText = "コンパイル中... (しばらくお待ちください。通常1〜2分かかります)\nブラウザが一時的に固まることがありますが、そのままにしてください。";
        const compiler = new Compiler();
        
        await compiler.compileImageTargets(images, (progress) => {
          progressBar.style.width = (20 + (progress * 0.8)) + "%";
          status.innerText = "コンパイル進行状況: " + Math.round(progress) + "%";
        });

        status.innerText = "エクスポート中...";
        const exportedBuffer = await compiler.exportData();
        
        const blob = new Blob([exportedBuffer]);
        const url = URL.createObjectURL(blob);
        downloadLink.href = url;
        downloadLink.download = "targets.mind";
        downloadLink.style.display = "block";
        status.innerText = "完了しました！下のボタンを押して保存してください。";
        status.style.color = "#28a745";
        progressBar.style.width = "100%";
        
      } catch (e) {
        console.error(e);
        status.innerText = "エラーが発生しました:\n" + e.message + "\n\n【解決策】\n1. Edgeのトラッキング防止をオフにする\n2. ネット接続を確認する\n3. ページを再読み込みする";
        status.style.color = "red";
        startBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
